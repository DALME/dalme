{% extends "base.html" %}
{% load static i18n %}

{% block content %}
<div id="ticket-detail" class="full-width v-cloak">
  <template v-if="dataset">
    <div class="row q-px-lg q-pt-lg q-pb-md" v-if="dataset">
      <div class="full-width row text-h4 q-pl-xs q-mb-sm">
        <span class="text-grey-10">${ dataset.subject }</span>
        <span class="text-weight-light text-grey-7 q-ml-sm">#${ dataset.id }</span>
        <q-btn
          v-if="showEdit"
          flat
          color="white"
          text-color="grey-9"
          icon="fas fa-bars"
          style="margin-left: auto;"
        >
        <q-menu fit anchor="bottom right" self="top right">
          <q-list padding dense class="text-grey-9">
            <q-item clickable v-close-popup @click="toggle_status">
              <q-item-section v-if="dataset.status == 0">Close ticket</q-item-section>
              <q-item-section v-else>Re-open ticket</q-item-section>
            </q-item>
            <q-separator spaced></q-separator>
            <q-item>
              <q-item-section class="text-weight-bold">Assign to:</q-item-section>
            </q-item>
            <template v-for="user in asignees">
              <q-item
                dense
                clickable
                v-close-popup
                size="10px"
                @click="assign_ticket(user.id)"
              >
                <q-item-section :class="{ 'text-light-blue-10 text-weight-bold': dataset.assigned_to && user.id == dataset.assigned_to.id }">${ user.full_name }</q-item-section>
              </q-item>
            </template>
            <q-separator spaced></q-separator>
            <q-item>
              <q-item-section class="text-weight-bold">Toggle tags:</q-item-section>
            </q-item>
            <template v-for="tag in dalme_base.$data.tagOptions">
              <q-item
                dense
                clickable
                v-close-popup
                size="10px"
                @click="toggle_tag(tag.value)"
              >
                <q-checkbox
                  dense
                  size="sm"
                  :value="tagsList.includes(tag.value)"
                  class="q-mr-sm"
                ></q-checkbox>
                <q-chip
                  :color="tag.color"
                  :label="tag.label"
                  text-color="grey-10"
                  dense
                  size="13px"
                ></q-chip>
              </q-item>
            </template>
          </q-list>
        </q-menu>
      </q-btn>
      </div>
      <div class="items-center">
        <q-chip
          :icon="dataset.status == 0 ? 'fas fa-exclamation-circle' : 'fas fa-check-circle'"
          :color="dataset.status == 0 ? 'green-8' : 'red-8'"
          size="14px"
          text-color="white"
          class="text-weight-bold q-mr-sm"
          :label="dataset.status == 0 ? 'Open' : 'Closed'"
        ></q-chip>
        <span class="text-body2">
          <a class="text-weight-bold" :href="dalme_base.$data.dbEndpoint + '/users/' + dataset.creation_user.username + '/'">${ dataset.creation_user.full_name }</a>
          opened this ticket ${ dalme_base.format_date(dataset.creation_timestamp, ['on ', '']) }
          ãƒ» ${ dataset.comment_count } comments
        </span>
      </div>
    </div>
    <q-separator></q-separator>
    <div class="row q-pt-lg q-mb-xl">
      <div class="column col-9">
        <q-list>
          <q-item class="q-py-sm q-px-lg">
            <q-item-section top avatar>
              <q-avatar v-if="dataset.creation_user.avatar" size="40px">
                <img :src="dataset.creation_user.avatar">
              </q-avatar>
              <q-avatar v-else size="40px" icon="fas fa-user" color="light-blue-3" text-color="blue-9">
              </q-avatar>
            </q-item-section>
            <q-item-section>
              <q-card flat bordered>
                <q-card-section class="bg-grey-2 q-py-sm">
                  <a class="text-weight-bold" :href="dalme_base.$data.dbEndpoint + '/users/' + dataset.creation_user.username + '/'">${ dataset.creation_user.full_name }</a>
                  commented ${ dalme_base.format_date(dataset.creation_timestamp, ['on ', ''], null, with_time=true) }
                </q-card-section>
                <q-separator></q-separator>
                <q-card-section class="text-body2">
                  ${ dataset.description }
                </q-card-section>
              </q-card>
            </q-item-section>
          </q-item>
          <template v-if="dataset.comments" v-for="comment in dataset.comments">
            <q-item class="q-py-sm q-px-lg">
              <q-item-section top avatar>
                <q-avatar v-if="comment.creation_user.avatar" size="40px">
                  <img :src="comment.creation_user.avatar">
                </q-avatar>
                <q-avatar v-else size="40px" icon="fas fa-user" color="light-blue-3" text-color="blue-9">
                </q-avatar>
              </q-item-section>
              <q-item-section>
                <q-card flat bordered>
                  <q-card-section class="bg-grey-2 q-py-sm">
                    <a class="text-weight-bold" :href="dalme_base.$data.dbEndpoint + '/users/' + comment.creation_user.username + '/'">${ comment.creation_user.full_name }</a>
                    commented ${ dalme_base.format_date(comment.creation_timestamp, ['on ', ''], null, with_time=true) }
                  </q-card-section>
                  <q-separator></q-separator>
                  <q-card-section class="text-body2" v-html="comment.body">
                  </q-card-section>
                </q-card>
              </q-item-section>
            </q-item>
          </template>
          <q-separator inset class="q-my-lg"></q-separator>

          <q-item class="q-py-sm q-px-lg">
            <q-item-section top avatar>
              <q-avatar v-if="dalme_base.$data.user.avatar" size="40px">
                <img :src="dalme_base.$data.user.avatar">
              </q-avatar>
              <q-icon v-else name="fas fa-user" size="40px">
              </q-icon>
            </q-item-section>
            <q-item-section>
              <q-card flat bordered>
                <q-card-section class="q-pa-sm">
                <q-editor
                  v-model="newComment"
                  min-height="7rem"
                  toolbar-text-color="grey-8"
                  toolbar-toggle-color="light-blue-10"
                  toolbar-bg="grey-2"
                  placeholder="Leave a comment..."
                  content-class="bg-grey-1"
                ></q-editor>
                </q-card-section>
                <q-card-actions align="right" class="q-px-sm q-pt-none">
                  <q-btn dense unelevated no-caps color="light-blue-10" @click="save_comment">Comment</q-btn>
                </q-card-actions>
              </q-card>

            </q-item-section>
          </q-item>

        </q-list>
      </div>
      <div class="column col-3 q-pl-sm q-pt-sm q-pr-lg text-caption">
        <div class="q-pb-md q-px-xs">
          <div class="text-weight-medium text-grey-9 full-width q-mb-sm">Status</div>
          <template v-if="dataset.status == 1">
            Closed ${ dalme_base.format_date(dataset.modification_timestamp, ['on ', '']) } by
            <a class="text-weight-bold" :href="dalme_base.$data.dbEndpoint + '/users/' + dataset.modification_user.username + '/'">
              ${ dataset.modification_user.full_name }
            </a>
          </template>
          <span v-else>Open</span>
        </div>
        <q-separator></q-separator>
        <div class="q-py-md q-px-xs">
          <div class="text-weight-medium text-grey-9 full-width q-mb-sm">Assigned to</div>
          <template v-if="dataset.assigned_to">
            <a class="text-weight-bold" :href="dalme_base.$data.dbEndpoint + '/users/' + dataset.assigned_to.username + '/'">
              ${ dataset.assigned_to.full_name }
            </a>
          </template>
          <span v-else>Not assigned</span>
        </div>
        <q-separator></q-separator>
        <div class="q-py-md q-px-xs">
          <div class="text-weight-medium text-grey-9 full-width q-mb-sm">Tags</div>
          <template v-if="hasTags">
            <q-chip
              v-for="tag in dataset.tags"
              v-if="tag.tag != 0"
              :color="get_tag_colour(tag.tag)"
              :label="tag.tag"
              text-color="grey-10"
              dense
              size="13px"
              class="q-my-none q-ml-none q-mr-xs"
            ></q-chip>
          </template>
          <span v-else>None yet</span>
        </div>
        <q-separator></q-separator>
        <div class="q-py-md q-px-xs">
          <div class="text-weight-medium text-grey-9 full-width q-mb-sm">Files</div>
          <template v-if="dataset.file">
            <q-img
              :src="dataset.file.source"
              spinner-color="white"
              style="display: block; width: 100%"
            ></q-img>
          </template>
          <span v-else>None</span>
        </div>
        <q-separator></q-separator>
        <div class="q-py-md q-px-xs">
          <div class="text-weight-medium text-grey-9 full-width q-mb-sm">Links</div>
          <template v-if="dataset.url">
          </template>
          <span v-else>None</span>
        </div>
      </div>
    </div>
  </template>
</div>
{% endblock %}

{% block extra_scripts %}
  {{ block.super }}
  <script>
    Quasar.iconSet.set(Quasar.iconSet.fontawesomeV5)
    const ticket = new Vue({
      el: '#ticket-detail',
      delimiters: ['${', '}'],
      mounted() {
        dalme_base.api_fetch('tickets', this.objectId, null, this.set_data);
        if (this.showEdit) {
          dalme_base.api_fetch(
            'users',
            null,
            { groups: 'Developers,Administrators,Super Administrators' },
            this.set_user_list
          );
        }
      },
      data: {
        objectId: {{ object.id }},
        dataset: null,
        newComment: null,
        showEdit: dalme_base.$data.user.groups.filter(value => ['Developers', 'Administrators', 'Super Administrators'].includes(value)).length ? true : false,
        asignees: null,
      },
      computed: {
        tagsList() {
          return this.dataset.tags.map(value => value.tag).filter(value => value != 0)
        },
        hasTags() {
          return this.tagsList.length ? true : false;
        },
      },
      methods: {
        set_data(data) {
          this.dataset = data;
        },
        get_tag_colour(tag) {
          return dalme_base.$data.tagOptions.find(o => o.value === tag).color;
        },
        set_user_list(data) {
          this.asignees = data;
        },
        toggle_status() {
          const code = this.dataset.status == 0 ? 1 : 0;
          this.update_ticket({status: code});
        },
        assign_ticket(id) {
          this.update_ticket({assigned_to: id});
        },
        toggle_tag(tag) {
          const tags = new Set(this.tagsList);
          if (tags.has(tag)) {
            tags.delete(tag)
          } else {
            tags.add(tag)
          }
          this.update_ticket({tags: [...tags]});
        },
        add_comment(data) {
          this.dataset.comments.push(data);
          this.newComment = null;
        },
        save_comment() {
          if (this.newComment) {
            const form_data = {
              model: 'Ticket',
              object: this.dataset.id,
              body: this.newComment
            }
            dalme_base.api_post('comments', null, form_data, 'POST', this.add_comment);
          }
        },
        update_ticket(data) {
          dalme_base.api_post('tickets', this.dataset.id, data, 'PATCH', this.set_data);
        }
      },
    })
  </script>
{% endblock %}
